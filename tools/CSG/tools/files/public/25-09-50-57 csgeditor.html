
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>CSG Editor - Mobile</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
      background: #1e1e1e;
      color: white;
    }

    #toolbar {
      display: flex;
      background: #2c3e50;
      color: white;
      padding: 0;
      gap: 0;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 10;
      position: relative;
    }

    #toolbar button {
      background: #3498db;
      color: white;
      border: none;
      font-size: 1em;
      width: 35px;
      height: 35px;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: none;
      border-radius: 0;
    }

    #toolbar button:active {
      transform: scale(0.95);
    }

    #toolbar button:hover {
      background: #2980b9;
    }
    
    .toolbar-separator {
      width: 1px;
      background-color: #446688;
      height: 35px;
    }

    #main-container {
      width: 100%;
      height: calc(100vh - 35px);
      position: relative;
    }

    #code-panel, #view-panel, #settings-panel {
      position: absolute;
      width: 100%;
      height: 100%;
      display: none;
      background: white;
    }

    #code-panel {
      background: #1e1e1e;
      color: #f8f8f8;
    }
    
    #settings-panel {
        background: #282c34;
        color: #f8f8f8;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
    }

    #settings-panel h2 {
        color: #61afef;
        border-bottom: 2px solid #545862;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    #settings-panel label {
        font-size: 1em;
        color: #a0a0a0;
        margin-bottom: 5px;
    }

    #settings-panel input[type="number"] {
        width: 80px;
        padding: 5px;
        background: #3e4451;
        border: 1px solid #545862;
        color: #f8f8f8;
        border-radius: 4px;
        margin-left: 10px;
    }

    #save-settings-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 20px;
    }

    #save-settings-btn:hover {
        background: #218838;
    }

    #three-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10000;
    }
    
    .modal-content {
        background: #282c34;
        width: 100%;
        height: 100%;
        max-width: 100%;
        max-height: 100%;
    }
  </style>

  <script type="importmap">
    {
      "imports": {
        "three": "./build/three.module.js",
        "three/addons/": "./jsm/",
        "three-mesh-bvh": "./js/mesh-bvh.js",
        "three-bvh-csg": "./js/csg-bvh.js"
      }
    }
  </script>
</head>
<body>

  <div id="toolbar">
    <button id="btn-3d" title="3D View">&#x1F5BC;</button>
    <div class="toolbar-separator"></div>
    <button id="btn-code" title="Code Editor">&#x1F4BB;</button>
    <div class="toolbar-separator"></div>
    <button id="btn-settings" title="Settings">&#x2699;</button>
    <div class="toolbar-separator"></div>
    <button id="btn-load" title="Load Project">&#x1F4E5;</button>
    <div class="toolbar-separator"></div>
    <button id="btn-save" title="Run Code">&#x1F4BE;</button>
  </div>

  <div id="main-container">
    <div id="code-panel">
      <textcode id="csg-code" title="CSG Script" onrun="runCSGCode(this);">
// Edit and save to update!
/*
return floor(
	difference(
		color(0x0000ffff,sphere({ r: 20, fn:100 })),
		translate([15, 0, 0], cube([20, 20, 20])),
		translate([0, 0, 15], cylinder({ r: 20, h: 30 , fn:100}))
	)
);
*/
//return cube([40, 50, 60]);

var b1= floor(
	translate([30,0,0],
		cylinder({d:10, h:20, fn:50})
	)
);

var b2= floor(
	translate([0,0,0],
		cube([10,10,10])
	)
);

return {
	b1:{
	data:b1,
	show:true
	},
	b2:{
	data:b2,
	show:true
	}
};
      </textcode>
    </div>

    <div id="view-panel">
      <canvas id="three-canvas"></canvas>
    </div>
    
    <div id="settings-panel">
        <h2>Settings</h2>
        <label for="width-input">Grid Width:</label>
        <input type="number" id="width-input" value="220" /> mm<br><br>
        <label for="length-input">Grid Length:</label>
        <input type="number" id="length-input" value="220" /> mm<br><br>
        <label for="grid-size-input">Grid Spacing:</label>
        <input type="number" id="grid-size-input" value="10" /> mm<br><br>
        <button id="save-settings-btn">Save Settings</button>
    </div>
  </div>

  <div id="load-code-modal" class="modal-overlay">
    <div class="modal-content">
        <filepicker 
            id="load-picker" 
            useFileButtonText="Load Code"
            onfilepick="handleLoadFile(event, filePath, 'csg-code')"
            oncancel="closeModal('load-code-modal')">
        </filepicker>
    </div>
  </div>

  <div id="save-code-modal" class="modal-overlay">
    <div class="modal-content">
        <filepicker 
            id="save-picker" 
            useFileButtonText="Save Code"
            onfilepick="handleSaveFile(event, filePath, 'csg-code')"
            oncancel="closeModal('save-code-modal')">
        </filepicker>
    </div>
  </div>

  <div id="save-stl-modal" class="modal-overlay">
    <div class="modal-content">
        <filepicker 
            id="save-stl-picker" 
            useFileButtonText="Save STL"
            onfilepick="handleSaveStl(event, filePath)"
            oncancel="closeModal('save-stl-modal')">
        </filepicker>
    </div>
  </div>

  <script type="module" src="/ux/textCode.js"></script>
  <script type="module" src="/ux/filePicker.js"></script>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { STLExporter } from 'three/addons/exporters/STLExporter.js';
    import * as SCAD from './js/scadCSG.js';
    import { Brush } from 'three-bvh-csg';
    import { api } from '/js/apiCalls.js';


    // --- Default & Stored Settings ---
    const DEFAULT_SETTINGS = {
        plateWidth: 220,
        plateLength: 220,
        gridSize: 10
    };
    let settings = { ...DEFAULT_SETTINGS };

    // --- DOM Elements ---
    const codePanel = document.getElementById('code-panel');
    const viewPanel = document.getElementById('view-panel');
    const btn3D = document.getElementById('btn-3d');
    const btnCode = document.getElementById('btn-code');
    const btnLoad = document.getElementById('btn-load');
    const btnSave = document.getElementById('btn-save');
    const btnSettings = document.getElementById('btn-settings');
    const settingsPanel = document.getElementById('settings-panel');
    const widthInput = document.getElementById('width-input');
    const lengthInput = document.getElementById('length-input');
    const gridSizeInput = document.getElementById('grid-size-input');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const loadCodeModal = document.getElementById('load-code-modal');
    const saveCodeModal = document.getElementById('save-code-modal');
    const saveStlModal = document.getElementById('save-stl-modal');

    // --- Three.js Setup ---
    const canvas = document.getElementById('three-canvas');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setClearColor(0x1e1e1e);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 2000);
    
    camera.position.set(0, 50, 50);
    camera.lookAt(0, 0, 0);
    
    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.dampingFactor = 0.1;

    // --- 3-Point Lighting ---
    const keyLight = new THREE.PointLight(0xffffff, 7, 1000, 0.2);
    const ambientLight = new THREE.AmbientLight(0xffcc66, 0.5);
    scene.add(keyLight, ambientLight);

    // --- Vertical Line at Origin (Y-axis) ---
    const originLineMaterial = new THREE.LineBasicMaterial({ color: 0x555555 });
    const originLineGeometry = new THREE.BufferGeometry().setFromPoints([
      new THREE.Vector3(0, -100, 0),
      new THREE.Vector3(0, 500, 0)
    ]);
    const originLine = new THREE.LineSegments(originLineGeometry, originLineMaterial);
    scene.add(originLine);

    // --- Flat Grid & Bounding Box ---
    let buildPlateGrid = null;
    let buildPlateBox = null;

    function createBuildPlate() {
        if (buildPlateGrid) {
            scene.remove(buildPlateGrid);
            buildPlateGrid.geometry.dispose();
            buildPlateGrid = null;
        }
        if (buildPlateBox) {
            scene.remove(buildPlateBox);
            buildPlateBox.geometry.dispose();
            buildPlateBox = null;
        }

        const plateSize = Math.max(settings.plateWidth, settings.plateLength);
        const divisions = Math.floor(plateSize / settings.gridSize);
        buildPlateGrid = new THREE.GridHelper(
            plateSize,
            divisions,
            0x555555,
            0x555555
        );
        buildPlateGrid.position.y = 0;
        scene.add(buildPlateGrid);

        const boxMaterial = new THREE.LineBasicMaterial({ color: 0xcccccc });
        const boxGeometry = new THREE.BufferGeometry();
        const halfWidth = settings.plateWidth / 2;
        const halfLength = settings.plateLength / 2;
        const boxVertices = new Float32Array([
            -halfWidth, 0, -halfLength,
             halfWidth, 0, -halfLength,
             halfWidth, 0, -halfLength,
             halfWidth, 0,  halfLength,
             halfWidth, 0,  halfLength,
            -halfWidth, 0,  halfLength,
            -halfWidth, 0,  halfLength,
            -halfWidth, 0, -halfLength
        ]);
        boxGeometry.setAttribute('position', new THREE.BufferAttribute(boxVertices, 3));
        buildPlateBox = new THREE.LineSegments(boxGeometry, boxMaterial);
        scene.add(buildPlateBox);
    }

    function resizeRenderer() {
      const width = window.innerWidth;
      const height = window.innerHeight - 35;
      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
    }
    window.addEventListener('resize', resizeRenderer);
    resizeRenderer();


    // --- View Management ---
    function showView(id) {
      codePanel.style.display = 'none';
      viewPanel.style.display = 'none';
      settingsPanel.style.display = 'none';
      btn3D.style.backgroundColor = '#3498db';
      btnCode.style.backgroundColor = '#3498db';
      btnSettings.style.backgroundColor = '#3498db';
      btnLoad.style.backgroundColor = '#3498db';
      btnSave.style.backgroundColor = '#3498db';
      if (id === '3d') {
        viewPanel.style.display = 'block';
        btn3D.style.backgroundColor = '#e74c3c';
      } else if (id === 'code') {
        codePanel.style.display = 'block';
        btnCode.style.backgroundColor = '#e74c3c';
      } else if (id === 'settings') {
        settingsPanel.style.display = 'block';
        btnSettings.style.backgroundColor = '#e74c3c';
      }
    }

    btn3D.addEventListener('click', () => showView('3d'));
    btnCode.addEventListener('click', () => showView('code'));
    btnSettings.addEventListener('click', () => showView('settings'));

    // --- Modal Functions ---
    window.openModal = (id) => {
        document.getElementById(id).style.display = 'flex';
    };

    window.closeModal = (id) => {
        document.getElementById(id).style.display = 'none';
    };

    // --- File Picker Callbacks (now global) ---
    window.handleLoadFile = async (event, filePath) => {
        try {
            const editor = document.querySelector('#csg-code');
            const fileContent = await api.readFile(filePath);
            const loadedValues = JSON.parse(fileContent);
            editor.values = loadedValues;
            editor.setAttribute('active', '0');
            runCSGCode(editor);
        } catch (error) {
            alert(`Failed to load code: ${error.message}`);
        }
        closeModal('load-code-modal');
    };

    window.handleSaveFile = async (event, filePath) => {
        try {
            const codeContent = document.querySelector('#csg-code').values;
            const codeContentString = JSON.stringify(codeContent, null, 2);
            await api.saveFile(filePath, codeContentString);
            alert(`Code saved successfully to: ${filePath}`);
        } catch (error) {
            alert(`Failed to save code: ${error.message}`);
        }
        closeModal('save-code-modal');
    };

    window.handleSaveStl = async (event, filePath) => {
        try {
            let finalPath = filePath;
            if (!finalPath.toLowerCase().endsWith('.stl')) {
                finalPath += '.stl';
            }
            const stlContent = window.stlToSave;
            if (!stlContent) {
                throw new Error("No STL content to save. Generate a model first.");
            }
            await api.saveFile(finalPath, stlContent, { 'Content-Type': 'text/plain' });
            alert(`STL file saved successfully to: ${finalPath}`);
        } catch (error) {
            alert(`Failed to save STL file: ${error.message}`);
        }
        closeModal('save-stl-modal');
    };

    const exporter = new STLExporter();

    function exportSTL() {
        if (currentObjects.length === 0) {
            alert('No objects to export!');
            return;
        }
        const exportGroup = new THREE.Group();
        currentObjects.forEach(obj => {
            if (obj.isMesh || obj instanceof Brush) {
                exportGroup.add(obj.clone());
            }
        });
        window.stlToSave = exporter.parse(exportGroup, { binary: false });
        openModal('save-stl-modal');
    }

    btnLoad.addEventListener('click', () => openModal('load-code-modal'));
    
    btnSave.addEventListener('click', () => {
        if (codePanel.style.display === 'block') {
            openModal('save-code-modal');
        } else {
            exportSTL();
        }
    });

    saveSettingsBtn.addEventListener('click', () => {
        const newWidth = parseFloat(widthInput.value);
        const newLength = parseFloat(lengthInput.value);
        const newGridSize = parseFloat(gridSizeInput.value);

        if (isNaN(newWidth) || newWidth <= 0 || isNaN(newLength) || newLength <= 0 || isNaN(newGridSize) || newGridSize <= 0) {
            alert('Please enter valid positive numbers for all settings.');
            return;
        }

        settings.plateWidth = newWidth;
        settings.plateLength = newLength;
        settings.gridSize = newGridSize;

        localStorage.setItem('csg-editor-settings', JSON.stringify(settings));

        createBuildPlate();
        alert('Settings saved successfully!');
    });

    // --- CSG Execution ---
    let currentObjects = [];
    window.runCSGCode = function(editor) {
      currentObjects.forEach(obj => scene.remove(obj));
      currentObjects = [];
      try {
        const code = editor.value;
        const script = new Function('sphere', 'cube', 'cylinder', 'union', 'difference', 'intersect', 'translate', 'rotate', 'scale', 'color', 'floor', 'convexHull', 'align', 'line3d', 'linePaths3d', `
          ${code}
        `);
        const result = script(SCAD.sphere, SCAD.cube, SCAD.cylinder, SCAD.union, SCAD.difference, SCAD.intersect, SCAD.translate, SCAD.rotate, SCAD.scale, SCAD.color, SCAD.floor, SCAD.convexHull, SCAD.align, SCAD.line3d, SCAD.linePaths3d);

        if (result instanceof THREE.Object3D || result instanceof Brush) {
          scene.add(result);
          currentObjects.push(result);
        } else if (Array.isArray(result)) {
          result.forEach(obj => {
            if (obj instanceof THREE.Object3D || obj instanceof Brush) {
              scene.add(obj);
              currentObjects.push(obj);
            }
          });
        } else if (typeof result === 'object' && result !== null) {
          for (const key in result) {
            const item = result[key];
            if (item && item.data && (item.data instanceof THREE.Object3D || item.data instanceof Brush) && item.show === true) {
              scene.add(item.data);
              currentObjects.push(item.data);
            }
          }
        }
      } catch (err) {
        console.error('CSG Error:', err);
        alert('CSG Error:\n' + err.message);
      }
    }

    document.addEventListener('run', function (e) {
      const editor = e.target;
      if (editor && editor.id === 'csg-code') {
        runCSGCode(editor);
      }
    });

    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (codePanel.style.display === 'block') {
            openModal('save-code-modal');
        } else if (viewPanel.style.display === 'block') {
            exportSTL();
        }
      }
    });

    // Animation Loop
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      const cameraDirection = new THREE.Vector3();
      camera.getWorldDirection(cameraDirection);
      keyLight.position.copy(camera.position).add(cameraDirection.multiplyScalar(-10));
      renderer.render(scene, camera);
    }
    animate();

    showView('3d');

    setTimeout(() => {
        const savedSettings = localStorage.getItem('csg-editor-settings');
        if (savedSettings) {
            settings = JSON.parse(savedSettings);
        }
        widthInput.value = settings.plateWidth;
        lengthInput.value = settings.plateLength;
        gridSizeInput.value = settings.gridSize;
        createBuildPlate();

        const editor = document.querySelector('#csg-code');
        const savedCode = localStorage.getItem('csg-editor-code');
        if (savedCode) {
            try {
                const loadedValues = JSON.parse(savedCode);
                editor.values = loadedValues;
                editor.setAttribute('active', '0');
            } catch (e) {
                editor.value = savedCode;
            }
        }
        runCSGCode(editor);
    }, 100);

    window.confirmClose = function () {
      if (confirm('Close editor?')) {
        showView('3d');
      }
    };
  </script>
</body>
</html>


