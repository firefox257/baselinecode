

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <title>CSG Editor - Mobile</title>
        <style>
            body,
            html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
                font-family: 'Segoe UI', sans-serif;
                background: #1e1e1e;
                color: white;
            }

            #toolbar {
                display: flex;
                background: #2c3e50;
                color: white;
                padding: 0;
                gap: 0;
                justify-content: center;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                z-index: 10;
                position: relative;
            }

            #toolbar button {
                background: #3498db;
                color: white;
                border: none;
                font-size: 1em;
                width: 35px;
                height: 35px;
                cursor: pointer;
                transition: background 0.2s, transform 0.1s;
                box-shadow: none;
                border-radius: 0;
            }

            #toolbar button:active {
                transform: scale(0.95);
            }

            #toolbar button:hover {
                background: #2980b9;
            }

            .toolbar-separator {
                width: 1px;
                background-color: #446688;
                height: 35px;
            }

            #main-container {
                width: 100%;
                height: calc(100vh - 30mm);
                position: relative;
            }

            #code-panel,
            #view-panel,
            #settings-panel,
            #editor-code-panel {
                position: absolute;
                width: 100vw;
                height: 100%;
                display: none;
                background: white;
            }
			
			 #csg-code, #editor-code {
				 
				 
				 
			 }

            #code-panel,
            #editor-code-panel {
                background: #1e1e1e;
                color: #f8f8f8;
            }

            #settings-panel {
                background: #282c34;
                color: #f8f8f8;
                padding: 20px;
                box-sizing: border-box;
                overflow-y: auto;
            }

            #settings-panel h2 {
                color: #61afef;
                border-bottom: 2px solid #545862;
                padding-bottom: 10px;
                margin-bottom: 20px;
            }

            #settings-panel label {
                font-size: 1em;
                color: #a0a0a0;
                margin-bottom: 5px;
            }

            #settings-panel input[type='number'],
            #settings-panel input[type='text'] {
                width: 80px;
                padding: 5px;
                background: #3e4451;
                border: 1px solid #545862;
                color: #f8f8f8;
                border-radius: 4px;
                margin-left: 10px;
            }

            #save-settings-btn {
                background: #28a745;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 20px;
            }

            #save-settings-btn:hover {
                background: #218838;
            }

            #clear-cache-btn {
                background: #dc3545;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 20px;
            }

            #clear-cache-btn:hover {
                background: #c82333;
            }

            #three-canvas {
                width: 100%;
                height: 100%;
                display: block;
            }

            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            }

            .modal-content {
                background: #282c34;
                width: 100%;
                height: 100%;
                max-width: 100%;
                max-height: 100%;
            }

            /* ---------- Console panel styles ---------- */
            /* Console container is fixed to bottom so it overlays the 3D area
               and other panels. It is resizable via the bar at its top. */
            #console-container {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                height: 180px; /* default height */
                display: flex;
                flex-direction: column;
                background: #0b0b0b;
                color: #e6e6e6;
                font-family: monospace;
                font-size: 12px;
                z-index: 0;
                border-top: 1px solid #333;
            }

            #console-resizer {
                height: 6px;
                cursor: ns-resize;
                background: linear-gradient(180deg, #222, #111);
                border-top: 1px solid #2b2b2b;
            }

            #console-panel {
                flex: 1;
                overflow-y: auto;
                padding: 8px;
                white-space: pre-wrap;
            }

            .console-log {
                color: #9fffb3;
                margin-bottom: 2px;
            }

            .console-warn {
                color: #ffd966;
                margin-bottom: 2px;
            }

            .console-error {
                color: #ff8b8b;
                margin-bottom: 2px;
            }
            
            .console-stack {
                color: #a0a0a0; /* Slightly different color for stack trace */
                font-size: 0.9em;
                margin-top: 4px;
                white-space: pre-wrap;
            }
            /* ---------- End console styles ---------- */

        </style>
		<script src ="./js/opentype.js"></script>
		<script>
		
		globalThis.opentype=opentype;
		</script>
        <script type="importmap">
            {
                "imports": {
                    "three": "./build/three.module.js",
                    "three/addons/": "./jsm/",
                    "three-mesh-bvh": "./js/mesh-bvh.js",
                    "three-bvh-csg": "./js/csg-bvh.js"
                }
            }
        </script>
    </head>
    <body>
        <div id="toolbar">
            <button id="btn-3d" title="3D View">&#x1F5BC;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-wireframe" title="Toggle Wireframe" style="display: none;">&#x1F4CB;</button>
            <div class="toolbar-separator" id="separator-wireframe" style="display: none;"></div>
            <button id="btn-code" title="CSG Code Editor">&#x1F4BB;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-editor-code" title="Editor Code">&#x2B9D;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-clear-cache-by-name" style="display: none;" title="Clear Current Cache">&#x2716;</button>
            <div class="toolbar-separator" id="separator-clear-cache" style="display: none;"></div>
            <button id="btn-settings" title="Settings">&#x2699;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-load" title="Load Project">&#x1F4E5;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-save" title="Save Project">&#x1F4BE;</button>
            <div class="toolbar-separator"></div>
            <button id="btn-clear-console" title="Clear Console">&#x1F5D1;</button>
        </div>

        <div id="main-container">
            <div id="code-panel">
                <textcode
                    id="csg-code"
                    title="CSG Script"
                    onrun="runCSGCode();">
 // Edit and save to update!

 
 
 
 

 
 
 /*
 
 return subdivide({resolution:3},
 	cube([50,50,50])
 );
 */
 
 /////////////
 
 var f1= await font("/fonts/advanced_dot_digital-7.ttf");
var ts= text({
		font:f1,
		text:"Dream Orphans0123%#",
		//text:"0",
		fn:30,
		fontSize:5
	});

ts = translatePath([10,0],ts)
//PrintLog(JSON.stringify(ts));
var s1=shape(ts);

return line3d(s1, [0, 0, 0], [0, 0, 0.1]);
	
 
 /////////
 
 
 //////////
 
 
 // A single, flattened array containing both the star and the circular hole.
// The newShape function will automatically classify these based on their nesting.
const myStarShapeData = {
    path: [
        'm', 0, 10,
        'l', 2.5, 2.5,
        'l', 10, 2.5,
        'l', 5, -2.5,
        'l', 7.5, -10,
        'l', 0, -5,
        'l', -7.5, -10,
        'l', -5, -2.5,
        'l', -10, 2.5,
        'l', -2.5, 2.5,
        'l', 0, 10, // Closes the star path

        //do mot do Start of the circular hole path. The new 'm' command signifies a new sub-path.
        'm', 2, 0,
        'a', 0, 0, 2, 0, Math.PI * 2, true // A full circle
    ]
};

// Create the shape using the newShape function.
const myStarShape= shape(myStarShapeData);

// Extrude the shape along the Y-axis (since the Z and Y axes are swapped in this code).
return line3d(myStarShape, [0, 0, 0], [0, 0, 20]);

 
 
 
 ////////////
 
 
 
/*
return floor(
	difference(
		color(0x0000ffff,sphere({ r: 20, fn:100 })),
		translate([15, 0, 0], cube([20, 20, 20])),
		translate([0, 0, 15], cylinder({ r: 20, h: 30 , fn:100}))
	)
);
*/
//return cube([40, 50, 60]);


var b1= floor(
	translate([30,0,0],
		cube([5,5,5])
	)
);

var b2= floor(
	translate([0,0,0],
		cube([10,10,10])
	)
);

return {
	b1:b1,
	b2:b2,
};
//*/

return floor(
	translate([30,0,0],
		union(

			translate([5,5,0],
				color(0xffff0000, cube([10,10,10]))
			),
			translate([0,0,0],
				cube([10,10,10])
			)
		)
	)
);
 
 
 

                </textcode>
            </div>

            <div id="editor-code-panel">
                <textcode
                    id="editor-code"
                    title="Editor Script"
                    onrun="runEditorScript();">
                    // Place reusable functions and objects here. // Access from
                    CSG Script with include("page name"); /* var constants = {
                    PI: Math.PI, E: Math.E }; return { constants }; */
                </textcode>
            </div>

            <div id="view-panel">
                <canvas id="three-canvas"></canvas>
            </div>

            <div id="settings-panel">
                <h2>Settings</h2>
                <label for="width-input">Grid Width:</label>
                <input type="number" id="width-input" value="220" />
                mm<br /><br />
                <label for="length-input">Grid Length:</label>
                <input type="number" id="length-input" value="220" />
                mm<br /><br />
                <label for="grid-size-input">Grid Spacing:</label>
                <input type="number" id="grid-size-input" value="10" />
                mm<br /><br />
                <label for="library-path-input">Library Path:</label>
                <input
                    type="text"
                    id="library-path-input"
                    value="/csgLib" /><br /><br />
                <button id="save-settings-btn">Save Settings</button>
                <button id="clear-cache-btn">Clear All Cache</button>
            </div>
        </div>

        <div id="load-code-modal" class="modal-overlay">
            <div class="modal-content">
                <filepicker
                    id="load-picker"
                    useFileButtonText="Load Code"
                    onfilepick="handleLoadFile(event, filePath)"
                    oncancel="closeModal('load-code-modal')">
                </filepicker>
            </div>
        </div>

        <div id="save-code-modal" class="modal-overlay">
            <div class="modal-content">
                <filepicker
                    id="save-picker"
                    useFileButtonText="Save Code"
                    onfilepick="handleSaveFile(event, filePath)"
                    oncancel="closeModal('save-code-modal')">
                </filepicker>
            </div>
        </div>

        <div id="save-stl-modal" class="modal-overlay">
            <div class="modal-content">
                <filepicker
                    id="save-stl-picker"
                    useFileButtonText="Save STL"
                    onfilepick="handleSaveStl(event, filePath)"
                    oncancel="closeModal('save-stl-modal')">
                </filepicker>
            </div>
        </div>

        <div id="console-container" aria-live="polite">
            <div id="console-resizer" title="Drag to resize console"></div>
            <div id="console-panel"></div>
        </div>
        <script type="module" src="/ux/textCode.js"></script>
        <script type="module" src="/ux/filePicker.js"></script>

        <script type="module">
            import * as THREE from 'three'
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js'

            import {
                initialize,
                //openModal,
                //closeModal,
                runCSGCode,
                runEditorScript,
                handleLoadFile,
                handleSaveFile,
                handleSaveStl,
                exportSTL,
                clearAllCache,
                clearCurrentCacheByName,
                toggleWireframe
            } from './js/editorCsg.js'

            globalThis.settings={};
            let currentObjects
            var domElements
            var renderer
            var scene
            var camera
            var controls
            var keyLight
            var ambientLight
            var originLine
            var buildPlateGrid = null
            var buildPlateBox = null

            // Make these functions available globally for the HTML event handlers
            window.openModal = openModal
            window.closeModal = closeModal
            window.runCSGCode = runCSGCode
            window.runEditorScript = runEditorScript
            window.handleLoadFile = handleLoadFile
            window.handleSaveFile = handleSaveFile
            window.handleSaveStl = handleSaveStl
            window.clearCurrentCacheByName = clearCurrentCacheByName

            function openModal(id) {
                document.getElementById(id).style.display = 'flex'
            }

            function closeModal(id) {
                document.getElementById(id).style.display = 'none'
            }

            // --- Three.js Setup Functions ---

            function setupThreeJs(canvas) {
                renderer = new THREE.WebGLRenderer({
                    canvas,
                    antialias: true
                })
                renderer.setClearColor(0x1e1e1e)
                renderer.setPixelRatio(window.devicePixelRatio)

                scene = new THREE.Scene()
                camera = new THREE.PerspectiveCamera(
                    60,
                    window.innerWidth / window.innerHeight,
                    0.01,
                    2000
                )

                camera.position.set(0, 50, 50)
                camera.lookAt(0, 0, 0)

                controls = new OrbitControls(camera, canvas)
                controls.enableDamping = true
                controls.dampingFactor = 0.1

                keyLight = new THREE.PointLight(0xffffff, 7, 1000, 0.2)
                ambientLight = new THREE.AmbientLight(0xffcc66, 0.5)
                scene.add(keyLight, ambientLight)

                const originLineMaterial = new THREE.LineBasicMaterial({
                    color: 0x555555
                })
                const originLineGeometry =
                    new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(0, -100, 0),
                        new THREE.Vector3(0, 500, 0)
                    ])
                originLine = new THREE.LineSegments(
                    originLineGeometry,
                    originLineMaterial
                )
                scene.add(originLine)
            }

            function createBuildPlate() {
                if (buildPlateGrid) {
                    scene.remove(buildPlateGrid)
                    buildPlateGrid.geometry.dispose()
                    buildPlateGrid = null
                }
                if (buildPlateBox) {
                    scene.remove(buildPlateBox)
                    buildPlateBox.geometry.dispose()
                    buildPlateBox = null
                }

                const plateSize = Math.max(
                    settings.plateWidth,
                    settings.plateLength
                )
                const divisions = Math.floor(plateSize / settings.gridSize)
                buildPlateGrid = new THREE.GridHelper(
                    plateSize,
                    divisions,
                    0x555555,
                    0x555555
                )
                buildPlateGrid.position.y = 0
                scene.add(buildPlateGrid)

                const boxMaterial = new THREE.LineBasicMaterial({
                    color: 0xcccccc
                })
                const boxGeometry = new THREE.BufferGeometry()
                const halfWidth = settings.plateWidth / 2
                const halfLength = settings.plateLength / 2
                const boxVertices = new Float32Array([
                    -halfWidth,
                    0,
                    -halfLength,
                    halfWidth,
                    0,
                    -halfLength,
                    halfWidth,
                    0,
                    halfLength,
                    halfWidth,
                    0,
                    halfLength,
                    -halfWidth,
                    0,
                    halfLength,
                    -halfWidth,
                    0,
                    -halfLength
                ])
                boxGeometry.setAttribute(
                    'position',
                    new THREE.BufferAttribute(boxVertices, 3)
                )
                buildPlateBox = new THREE.LineSegments(boxGeometry, boxMaterial)
                scene.add(buildPlateBox)
            }

            function resizeRenderer() {
                const canvas = renderer.domElement
                const width = canvas.clientWidth
                const height = canvas.clientHeight

                if (canvas.width !== width || canvas.height !== height) {
                    renderer.setSize(width, height, false)
                    camera.aspect = width / height
                    camera.updateProjectionMatrix()
                }
            }

            function animate() {
                requestAnimationFrame(animate)
                controls.update()
                const cameraDirection = new THREE.Vector3()
                camera.getWorldDirection(cameraDirection)
                keyLight.position
                    .copy(camera.position)
                    .add(cameraDirection.multiplyScalar(-10))
                renderer.render(scene, camera)
            }

            // --- UI Management and File Handling ---
            function showView(id) {
                const dom = {
                    codePanel: document.getElementById('code-panel'),
                    viewPanel: document.getElementById('view-panel'),
                    settingsPanel: document.getElementById('settings-panel'),
                    editorCodePanel:
                        document.getElementById('editor-code-panel'),
                    btn3D: document.getElementById('btn-3d'),
                    btnCode: document.getElementById('btn-code'),
                    btnEditorCode: document.getElementById('btn-editor-code'),
                    btnSettings: document.getElementById('btn-settings'),
                    btnClearCacheByName: document.getElementById('btn-clear-cache-by-name'),
                    separatorClearCache: document.getElementById('separator-clear-cache'),
                    btnWireframe: document.getElementById('btn-wireframe'),
                    separatorWireframe: document.getElementById('separator-wireframe')
                }

                dom.codePanel.style.display = 'none'
                dom.viewPanel.style.display = 'none'
                dom.settingsPanel.style.display = 'none'
                dom.editorCodePanel.style.display = 'none'

                dom.btn3D.style.backgroundColor = '#3498db'
                dom.btnCode.style.backgroundColor = '#3498db'
                dom.btnEditorCode.style.backgroundColor = '#3498db'
                dom.btnSettings.style.backgroundColor = '#3498db'

                // Hide the new buttons and separators by default
                dom.btnClearCacheByName.style.display = 'none';
                dom.separatorClearCache.style.display = 'none';
                dom.btnWireframe.style.display = 'none';
                dom.separatorWireframe.style.display = 'none';


                if (id === '3d') {
                    dom.viewPanel.style.display = 'block'
                    dom.btn3D.style.backgroundColor = '#e74c3c'
                    dom.btnWireframe.style.display = 'block';
                    dom.separatorWireframe.style.display = 'block';
                } else if (id === 'code') {
                    dom.codePanel.style.display = 'block'
                    dom.btnCode.style.backgroundColor = '#e74c3c'
                    // Show the new button for code view
                    dom.btnClearCacheByName.style.display = 'block';
                    dom.separatorClearCache.style.display = 'block';
                } else if (id === 'editor-code') {
                    dom.editorCodePanel.style.display = 'block'
                    dom.btnEditorCode.style.backgroundColor = '#e74c3c'
                    // Show the new button for editor code view
                    dom.btnClearCacheByName.style.display = 'block';
                    dom.separatorClearCache.style.display = 'block';
                } else if (id === 'settings') {
                    dom.settingsPanel.style.display = 'block'
                    dom.btnSettings.style.backgroundColor = '#e74c3c'
                }
            }

            function saveSettings(domElements) {
                const newWidth = parseFloat(domElements.widthInput.value)
                const newLength = parseFloat(domElements.lengthInput.value)
                const newGridSize = parseFloat(domElements.gridSizeInput.value)
                const newLibraryPath = domElements.libraryPathInput.value

                if (
                    isNaN(newWidth) ||
                    newWidth <= 0 ||
                    isNaN(newLength) ||
                    newLength <= 0 ||
                    isNaN(newGridSize) ||
                    newGridSize <= 0
                ) {
                    alert(
                        'Please enter valid positive numbers for all settings.'
                    )
                    return
                }

                settings.plateWidth = newWidth
                settings.plateLength = newLength
                settings.gridSize = newGridSize
                settings.libraryPath = newLibraryPath

                localStorage.setItem(
                    'csg-editor-settings',
                    JSON.stringify(settings)
                )

                createBuildPlate()
                alert('Settings saved successfully!')
            }

            window.onload = function () {
                // Collect all the DOM elements and pass them to the initializer function
                domElements = {
                    btn3D: document.getElementById('btn-3d'),
                    btnCode: document.getElementById('btn-code'),
                    btnEditorCode: document.getElementById('btn-editor-code'),
                    btnSettings: document.getElementById('btn-settings'),
                    btnLoad: document.getElementById('btn-load'),
                    btnSave: document.getElementById('btn-save'),
                    clearConsoleBtn: document.getElementById('btn-clear-console'),
                    btnWireframe: document.getElementById('btn-wireframe'),
                    widthInput: document.getElementById('width-input'),
                    lengthInput: document.getElementById('length-input'),
                    gridSizeInput: document.getElementById('grid-size-input'),
                    libraryPathInput:
                        document.getElementById('library-path-input'),
                    saveSettingsBtn:
                        document.getElementById('save-settings-btn'),
                    clearCacheBtn: document.getElementById('clear-cache-btn'),
                    csgEditor: document.getElementById('csg-code'),
                    editorCodeEditor: document.getElementById('editor-code'),
                    codePanel: document.getElementById('code-panel'),
                    editorCodePanel:
                        document.getElementById('editor-code-panel'),
                    viewPanel: document.getElementById('view-panel'),
                    settingsPanel: document.getElementById('settings-panel'),
                    canvas: document.getElementById('three-canvas'),
                    openModal: openModal,
                    closeModal: closeModal,
                    setupThreeJs: setupThreeJs,
                    createBuildPlate: createBuildPlate,
                    resizeRenderer: resizeRenderer,
                    animate: animate,
                    get scene() {
                        return scene
                    },
                    showView: showView
                }

                // Initial settings load

                settings = {
                    plateWidth: 220,
                    plateLength: 220,
                    gridSize: 10,
                    libraryPath: '/csgLib'
                }
                const savedSettings = localStorage.getItem(
                    'csg-editor-settings'
                )
                if (savedSettings) {
                    settings = JSON.parse(savedSettings)
                }
                domElements.widthInput.value = settings.plateWidth
                domElements.lengthInput.value = settings.plateLength
                domElements.gridSizeInput.value = settings.gridSize
                domElements.libraryPathInput.value = settings.libraryPath
                domElements.settings = settings

                // Setup Three.js
                setupThreeJs(domElements.canvas)
                //createBuildPlate();
                //resizeRenderer();
                //animate();

                // Set up event listeners
                domElements.btn3D.addEventListener('click', () =>
                    showView('3d')
                )
                domElements.btnCode.addEventListener('click', () =>
                    showView('code')
                )
                domElements.btnEditorCode.addEventListener('click', () =>
                    showView('editor-code')
                )
                domElements.btnSettings.addEventListener('click', () =>
                    showView('settings')
                )
                domElements.btnLoad.addEventListener('click', () =>
                    openModal('load-code-modal')
                )
                // New event listener for the Clear Console button
                domElements.clearConsoleBtn.addEventListener('click', () => {
                    document.getElementById('console-panel').innerHTML = '';
                });
                // New event listener for the Clear Cache button
                document.getElementById('btn-clear-cache-by-name').addEventListener('click', clearCurrentCacheByName);
                // New event listener for the Toggle Wireframe button
                document.getElementById('btn-wireframe').addEventListener('click', toggleWireframe);


                // Corrected Save Button Logic
                domElements.btnSave.addEventListener('click', () => {
                    const { btnCode, btnEditorCode, btnSettings, btn3D } =
                        domElements
                    const activeColor = 'rgb(231, 76, 60)'

                    if (
                        btnCode.style.backgroundColor === activeColor ||
                        btnEditorCode.style.backgroundColor === activeColor
                    ) {
                        openModal('save-code-modal')
                    } else if (btn3D.style.backgroundColor === activeColor) {
                        exportSTL()
                    } else if (
                        btnSettings.style.backgroundColor === activeColor
                    ) {
                        saveSettings(domElements)
                    }
                })

                domElements.saveSettingsBtn.addEventListener('click', () =>
                    saveSettings(domElements)
                )
                domElements.clearCacheBtn.addEventListener(
                    'click',
                    clearAllCache
                )

                initialize(domElements)
                // Initial view and render
                showView('3d')
                createBuildPlate()
                resizeRenderer()
                animate()
                runCSGCode()
            }
			
			
        </script>
    </body>
</html>


